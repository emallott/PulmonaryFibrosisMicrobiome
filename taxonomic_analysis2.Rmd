---
title: "Taxonomic Analysis"
author: "Liz Mallott"
date: "9/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Loading required libraries

The following libraries are required for this analysis:
tidyverse (v.1.3.0)
vegan (v.2.5-6)
pairwiseAdonis (v.0.3, https://github.com/pmartinezarbizu/pairwiseAdonis)
cowplot (v.1.1.0)
glmmTMB (v.1.0.2.1)
multcomp (v.1.4-14)
car (v.3.0-9)
fdrtool (v.1.2.15)

```{r load_libraries}
library(tidyverse)
library(vegan)
library(pairwiseAdonis)
library(cowplot)
library(glmmTMB)
library(multcomp)
library(car)
library(fdrtool)
library(ggpubr)
library(vroom)
```

## Importing data

The species-level merged relative abundance table from MetaPhlan and metadata files are loaded. All germ-free and all control samples are removed and the relative abundance table is transposed for ease of use in vegan.

```{r import_data_fecal}
species = read_tsv("merged_abundance_table_all_species.txt")
phyla = read_tsv("merged_abundance_table_all_phyla.txt")
phyla_t = phyla[, colSums(phyla != 0) > 0] %>% pivot_longer(-body_site) %>% 
  pivot_wider(names_from=body_site, values_from=value)
metadata = read_tsv("metadata_combined.txt", col_types = "cccfffffddffff")
species_t = species[, colSums(species != 0) > 0] %>% pivot_longer(-body_site) %>% 
  pivot_wider(names_from=body_site, values_from=value)
species_meta = inner_join(metadata, species_t) %>% filter(Stool_origin == "ABSL1" | Stool_origin == "ABSL2") %>% 
  filter(Treatment != "CONTROL")
```

Taxonomic data for lung samples was obtained from Kaiju and imported. An OTU-like table was constructed. Taxa with <3 reads were filtered out prior to downstream analysis. Sample 35 was removed as it appears to be an outlier.

```{r import_data_lung}
files = fs::dir_ls(path = "kaiju_out", glob = "*summary.tsv")

kaiju = vroom(files)

lung_species = kaiju %>%
  dplyr::select(file, reads, taxon_name) %>% 
  pivot_wider(names_from = "taxon_name", values_from = "reads") %>%
  replace(is.na(.),0) 

lung_species_filtered = lung_species %>%  
  mutate(Sample = basename(file)) %>% 
  mutate(SampleID = str_split(Sample, "_") %>% map_chr(.,1))

lung_species_filtered_meta = inner_join(metadata, lung_species_filtered)

#write to CSV and remove eukaryotes and low abundance taxa (<3 reads)
write_csv(lung_species_filtered_meta, "lung_kaiju_species_otutable.csv")

lung_species_filtered_meta2 = read_csv("lung_kaiju_species_otutable2.csv")
lung_species_filtered_meta_floors = lung_species_filtered_meta2 %>% 
  filter(Floor == "ABSL1" | Floor == "ABSL2") %>% 
  filter(SampleID != "6739-OC-35")

lung_species_filtered_meta_floors_relab = decostand(lung_species_filtered_meta_floors[,15:350], method = "total")

phyla_lung = read_csv("lung_kaiju_phyla_otutable2_relab.csv")
phyla_lung_floor = read_csv("lung_kaiju_phyla_otutable2_relab_floor.csv") %>% 
  dplyr::select(SampleID, Actinobacteria:Other) %>% 
  pivot_longer(-1, names_to = "Phyla", values_to = "Relative abundance")
```

## Calculating distance matrices

Bray-Curtis and Jaccard distance matrices are calculated in vegan.

```{r distances}
bray_fecal = vegdist(species_meta[,15:64], method = "bray")
jaccard_fecal = vegdist(species_meta[15:64], method = "jaccard", 
                  binary = T)
write_csv(data.frame(as.matrix(bray_fecal)), "bray_stool_samples.csv")
write_csv(data.frame(as.matrix(jaccard_fecal)), "jaccard_stool_samples.csv")

bray_lung_floors = vegdist(lung_species_filtered_meta_floors_relab, 
                    method = "bray")
jaccard_lung_floors = vegdist(lung_species_filtered_meta_floors_relab, 
                       method = "jaccard", binary = T)
```

## PERMANOVAs

A PERMANOVA is performed to assess if stool origin (from a mouse from an ABSL1 or ABSL2 floor) or current housing (Germ-free vs. ABSL1 vs. ABSL2) has a larger effect. 

We will first look at composition taking species abundance into account (Bray-Curtis metric).

```{r permanova_bray}
adonis2(bray_fecal ~ Stool_origin + Floor, data=species_meta, 
        by = "margin", permutations = 4999)
```

And then at presence-absence (Jaccard metric).

```{r permanova_jaccard}
adonis2(jaccard_fecal ~ Stool_origin + Floor, data=species_meta, 
        by = "margin", permutations = 4999)
```

A PERMANOVA is performed to assess if the lung microbiome is distinct between ABSL1 and ABSL2 mice.

```{r permanova_lungs}
adonis2(bray_lung_floors ~ Floor + Treatment, data=lung_species_filtered_meta_floors, 
        by = "margin", permutations = 4999)

adonis2(jaccard_lung_floors ~ Floor + Treatment, data=lung_species_filtered_meta_floors, 
        by = "margin", permutations = 4999)
```

## Average distance

We then reshaped the distance matrices so we can compare distances between ABSL1 and ABSL1-gavaged miced, ABSL2 and ABSL2-gavaged mice, ABSL1 and ABSL2 mice, and ABLS1-gavaged and ABSL2-gavaged mice.


```{r reshape_fecal_distance}
bray_df = data.frame(as.matrix(bray_fecal))
rownames(bray_df) = species_meta$SampleID
colnames(bray_df) = species_meta$SampleID
bray_df_si = bray_df %>% rownames_to_column(var = "SampleID")
bray_df_long = bray_df_si %>% 
  pivot_longer(-1, names_to = "SampleID2", 
               values_to = "bray_distance") %>% 
  filter(bray_distance > 0) %>% 
  inner_join(metadata, by = c("SampleID" = "SampleID")) %>% 
  dplyr::select(SampleID, SampleID2, bray_distance, Floor, Stool_origin) %>%
  rename(Floor1 = Floor) %>% rename(Stool_origin1 = Stool_origin) %>% 
    inner_join(metadata, by = c("SampleID2" = "SampleID")) %>% 
  dplyr::select(SampleID, SampleID2, bray_distance, Floor1, 
                Stool_origin1, Floor, Stool_origin) %>%
  rename(Floor2 = Floor) %>% rename(Stool_origin2 = Stool_origin)

bray_df_long_recode = bray_df_long %>% 
  mutate(Floors = paste(Floor1, Floor2, sep = "-")) %>% 
  mutate(Stool_origins = paste(Stool_origin1, Stool_origin2, sep = "-")) %>%
  mutate(combo = case_when(Floors == "Germ-free-ABSL1" &
              Stool_origins == "ABSL1-ABSL1" ~ 
              "GF-ABSL1-Exp-ABSL1",
            Floors == "Germ-free-ABSL2" & 
              Stool_origins == "ABSL2-ABSL2" ~
              "GF-ABSL2-Exp-ABSL2",
            Floors == "ABSL1-ABSL2" &
              Stool_origins == "ABSL1-ABSL2" ~
              "Exp-ABSL1-Exp-ABSL2",
            Floors == "Germ-free-Germ-free" & 
              Stool_origins == "ABSL1-ABSL2" ~
              "GF-ABSL1-GF-ABSL2",
            Floors == "Germ-free-ABSL1" & 
              Stool_origins == "ABSL2-ABSL1" ~
              "GF-ABSL2-Exp-ABSL1",
            Floors == "Germ-free-ABSL2" & 
              Stool_origins == "ABSL1-ABSL2" ~
              "GF-ABSL1-Exp-ABSL2")) %>% 
  filter(combo != is.na(.))

jaccard_df = data.frame(as.matrix(jaccard_fecal))
rownames(jaccard_df) = species_meta$SampleID
colnames(jaccard_df) = species_meta$SampleID
jaccard_df_si = jaccard_df %>% rownames_to_column(var = "SampleID")
jaccard_df_long = jaccard_df_si %>% 
  pivot_longer(-1, names_to = "SampleID2", 
               values_to = "jaccard_distance") %>% 
  filter(jaccard_distance > 0) %>% 
  inner_join(metadata, by = c("SampleID" = "SampleID")) %>% 
  dplyr::select(SampleID, SampleID2, jaccard_distance, Floor, Stool_origin) %>%
  rename(Floor1 = Floor) %>% rename(Stool_origin1 = Stool_origin) %>% 
    inner_join(metadata, by = c("SampleID2" = "SampleID")) %>% 
  dplyr::select(SampleID, SampleID2, jaccard_distance, Floor1, 
                Stool_origin1, Floor, Stool_origin) %>%
  rename(Floor2 = Floor) %>% rename(Stool_origin2 = Stool_origin)

jaccard_df_long_recode = jaccard_df_long %>% 
  mutate(Floors = paste(Floor1, Floor2, sep = "-")) %>% 
  mutate(Stool_origins = paste(Stool_origin1, Stool_origin2, sep = "-")) %>%
  mutate(combo = case_when(Floors == "Germ-free-ABSL1" &
              Stool_origins == "ABSL1-ABSL1" ~ 
              "GF-ABSL1-Exp-ABSL1",
            Floors == "Germ-free-ABSL2" & 
              Stool_origins == "ABSL2-ABSL2" ~
              "GF-ABSL2-Exp-ABSL2",
            Floors == "ABSL1-ABSL2" &
              Stool_origins == "ABSL1-ABSL2" ~
              "Exp-ABSL1-Exp-ABSL2",
            Floors == "Germ-free-Germ-free" & 
              Stool_origins == "ABSL1-ABSL2" ~
              "GF-ABSL1-GF-ABSL2",
            Floors == "Germ-free-ABSL1" & 
              Stool_origins == "ABSL2-ABSL1" ~
              "GF-ABSL2-Exp-ABSL1",
            Floors == "Germ-free-ABSL2" & 
              Stool_origins == "ABSL1-ABSL2" ~
              "GF-ABSL1-Exp-ABSL2")) %>% 
  filter(combo != is.na(.))
```

We then use a linear model followed by a Tukey comparison to test if average distances differ significantly between treatments.

```{r fecal_distance_test}
bray_df_long_recode$combo = as.factor(bray_df_long_recode$combo)
distance = lm(bray_distance ~ combo, data = bray_df_long_recode)
summary(distance)
Anova(distance)
summary(glht(distance,linfct=mcp(combo="Tukey")))

avg = bray_df_long_recode %>% group_by(combo) %>% 
  summarize(average = mean(bray_distance), stddv = sd(bray_distance), n = n(), se = stddv/sqrt(n))
avg

boxplot(bray_distance ~ combo, data = bray_df_long_recode)

jaccard_df_long_recode$combo = as.factor(jaccard_df_long_recode$combo)
distance = lm(jaccard_distance ~ combo, data = jaccard_df_long_recode)
summary(distance)
Anova(distance)
summary(glht(distance,linfct=mcp(combo="Tukey")))

avg = jaccard_df_long_recode %>% group_by(combo) %>% 
  summarize(average = mean(jaccard_distance), stddv = sd(jaccard_distance), n = n(), se = stddv/sqrt(n))
avg

boxplot(jaccard_distance ~ combo, data = jaccard_df_long_recode)
```

```{r avg_distance_graphs}
avg_plot_bray = ggboxplot(bray_df_long_recode, x = "combo", 
                    y = "bray_distance", 
                    palette = "Set1", add = "jitter", 
                    add.params = list(fill = "white"), 
                 ylab = "Bray-Curtis distance",
                 x.text.angle = 90) 
avg_plot_bray = ggpar(avg_plot_bray, legend = "right") + 
  rremove("xlab") + rremove("x.text") +
  rremove("legend.title") + 
  stat_compare_means(label = "p.signif", 
                     comparisons = list(c("GF-ABSL1-Exp-ABSL1",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL1-Exp-ABSL2",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL1-GF-ABSL2",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL2-Exp-ABSL1",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL2-Exp-ABSL2",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL1-GF-ABSL2",
                                          "GF-ABSL1-Exp-ABSL1"),
                                        c("GF-ABSL1-GF-ABSL2",
                                          "GF-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL2-Exp-ABSL2",
                                          "GF-ABSL1-GF-ABSL2"),
                                        c("GF-ABSL2-Exp-ABSL1",
                                          "GF-ABSL1-GF-ABSL2")),
                     symnum.args = list(cutpoints = 
                                          c(0, 0.001, 0.8, 0.9, 1),
                                        symbols = c("***",  "**", "*","ns")))
avg_plot_bray

avg_plot_jaccard = ggboxplot(jaccard_df_long_recode, x = "combo", 
                    y = "jaccard_distance", 
                    palette = "Set1", add = "jitter", 
                    add.params = list(fill = "white"), 
                 ylab = "Jaccard distance",
                 x.text.angle = 90) 
avg_plot_jaccard = ggpar(avg_plot_jaccard, legend = "right") + 
  rremove("xlab") + 
  rremove("legend.title") + 
  stat_compare_means(label = "p.signif", 
                     comparisons = list(c("GF-ABSL1-Exp-ABSL1",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL1-Exp-ABSL2",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL1-GF-ABSL2",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL2-Exp-ABSL1",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL2-Exp-ABSL2",
                                          "Exp-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL1-GF-ABSL2",
                                          "GF-ABSL1-Exp-ABSL1"),
                                        c("GF-ABSL2-Exp-ABSL1",
                                          "GF-ABSL1-Exp-ABSL1"),
                                        c("GF-ABSL2-Exp-ABSL2",
                                          "GF-ABSL1-Exp-ABSL1"),
                                        c("GF-ABSL1-GF-ABSL2",
                                          "GF-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL2-Exp-ABSL1",
                                          "GF-ABSL1-Exp-ABSL2"),
                                        c("GF-ABSL2-Exp-ABSL2",
                                          "GF-ABSL1-Exp-ABSL2")),
                     symnum.args = list(cutpoints = 
                                          c(0, 0.001, 0.5, 1),
                                        symbols = c("***",  "*", "ns")))
avg_plot_jaccard
```

```{r avg_distance_plot}
tiff(file="avg_distance_plots.tif", res=300, width=12, height=10, units="in")
ggarrange(avg_plot_bray, avg_plot_jaccard, nrow = 2, ncol = 1, 
          align = "v", heights = c(1.5,2))
dev.off()
```


####################3


## Phyla bar plots

After collapsing the table at the phyla level, we constructed bar plots to visualize differences between the ABSL1 and ABSL2 floors.

```{r barplot_lung}
tiff(file="phyla_barplot_lung_floor.tif", res=300, width=12, height=6.5, units="in")
phyla_plot = ggbarplot(phyla_lung_floor, x = "SampleID", y = "Relative abundance",
          fill = "Phyla", color = "Phyla", palette = "Set1",
          width = 1)
ggpar(phyla_plot, legend = "right") +  
          rremove("x.text") + rremove("xlab")
dev.off()
```

## NMDS plots

We constructed a non-linear multidimensional scaling plot for the Bray-Curtis metric.

```{r nmds_bray_lung}
mds_otus_bray_lung_floor<-metaMDS(bray_lung_floors, k=2, trymax=499)
mmds_otus_bray_lung_floor_points<-mds_otus_bray_lung_floor$points
mmds_otus_bray_lung_floor_points2<-merge(x=mmds_otus_bray_lung_floor_points, 
                             y = lung_species_filtered_meta_floors, 
                             by.x = "row.names", 
                             by.y = "row.names")

mmds_otus_bray_lung_floor_points2$Floor = factor(mmds_otus_bray_lung_floor_points2$Floor,
                                     levels = c("ABSL1", "ABSL2"))

tiff(file="nmds_plot_bray_lung_floors.tif", res=300, width=8, height=6, units="in")
bray_lung_floor_plot <- ggplot(mmds_otus_bray_lung_floor_points2, 
                    aes(x = MDS1, y = MDS2, color = Floor, 
                        shape = Treatment)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8)))
bray_lung_floor_plot
dev.off()
bray_lung_floor_plot
```
PDF plots are included below
```{r bray_lung_floor_pdf}
pdf(file="nmds_plot_bray_lung_floors.pdf", width=8, height=6)
lung_species_filtered_meta_floors
dev.off()
```

We constructed a non-linear multidimensional scaling plot for the Jaccard metric.

```{r nmds_jaccard_lung}
mds_otus_jaccard_lung_floor<-metaMDS(jaccard_lung_floors, k=2, trymax=499)
mmds_otus_jaccard_lung_floor_points<-mds_otus_jaccard_lung_floor$points
mmds_otus_jaccard_lung_floor_points2<-merge(x=mmds_otus_jaccard_lung_floor_points, 
                             y = lung_species_filtered_meta_floors, 
                             by.x = "row.names", 
                             by.y = "row.names")

mmds_otus_jaccard_lung_floor_points2$Floor = factor(mmds_otus_jaccard_lung_floor_points2$Floor,
                                     levels = c("ABSL1", "ABSL2"))

tiff(file="nmds_plot_jaccard_lung_floors.tif", res=300, width=8, height=6, units="in")
jaccard_lung_floor_plot <- ggplot(mmds_otus_jaccard_lung_floor_points2, 
                    aes(x = MDS1, y = MDS2, color = Floor, 
                        shape = Treatment)) +
  geom_point(size=3) + scale_color_brewer(palette = 'Set1') +
  theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
        legend.key=element_blank()) + 
  theme(axis.title.x=element_text(size=rel(2)), 
        axis.title.y=element_text(size=rel(2)),
        plot.title = element_text(size=rel(3)),
        legend.title = element_text(size=rel(2)),
        legend.text = element_text(size = rel(1.8)))
jaccard_lung_floor_plot
dev.off()
jaccard_lung_floor_plot
```
PDF plots are included below
```{r bray_pdf}
pdf(file="nmds_plot_jaccard_lung_floor.pdf", width=8, height=6)
jaccard_lung_floor_plot
dev.off()
```

## Alpha diversity

ABSL1 and ABSL2 lung samples only.
```{r alpha}
shannond = diversity(lung_species_filtered_meta_floors[,15:350], index = "shannon")

shannone = shannond/log(specnumber(lung_species_filtered_meta_floors[,15:350]))

diversity = cbind(lung_species_filtered_meta_floors[,1:14], shannond, shannone)

diversity$Floor = factor(diversity$Floor,
                                     levels = c("ABSL1", "ABSL2"))

div = wilcox.test(shannond ~ Floor, 
                        data = diversity)
div

divt = wilcox.test(shannond ~ Treatment, 
                        data = diversity)
divt

even = wilcox.test(shannone ~ Floor, 
                        data = diversity)
even

event = wilcox.test(shannone ~ Treatment, 
                        data = diversity)
event

div_lm = lm(shannond ~ Floor*Treatment, 
            data = diversity)
Anova(div_lm)



div_plot = ggboxplot(diversity, x = "Floor", 
                    y = "shannond", color = "Floor", 
                    palette = "Set1", add = "jitter", 
                    add.params = list(fill = "white"), 
                 ylab = "Shannon Diversity") 
div_plot = ggpar(div_plot, legend = "right") + 
  rremove("xlab") + rremove("x.text") + 
  rremove("legend.title")
div_plot

even_plot = ggboxplot(diversity, x = "Floor", 
                    y = "shannone", color = "Floor", 
                    palette = "Set1", add = "jitter", 
                    add.params = list(fill = "white"), 
                 ylab = "Shannon Evenness") 
even_plot = ggpar(even_plot, legend = "right") + 
  rremove("xlab") + rremove("x.text") + 
  rremove("legend.title") 
even_plot

tiff(file="Floor_diversity.tif", res=300, width=4, height=3, units="in")
div_plot
dev.off()
```

## Individual taxonomic differences

We ran a generalized linear model with a negative binomial distribution to assess the influence of floor on the relative abundance of all phyla detected in the lung microbiome.

```{r phyla_comp_lung_floor}
phyla_lung_floor_wide = phyla_lung %>% 
  filter(Floor == "ABSL1" | Floor == "ABSL2")

glht_glmmTMB <- function (model, ..., component="cond") {
  glht(model, ...,
       coef. = function(x) fixef(x)[[component]],
       vcov. = function(x) vcov(x)[[component]],
       df = NULL)
}
modelparm.glmmTMB <- function (model, coef. = function(x) fixef(x)[[component]],
                               vcov. = function(x) vcov(x)[[component]],
                               df = NULL, component="cond", ...) {
  multcomp:::modelparm.default(model, coef. = coef., vcov. = vcov.,
                               df = df, ...)
}

actino = glmmTMB(Actinobacteria ~ Floor + Treatment, 
                  data = phyla_lung_floor_wide, family = nbinom2)
Anova(actino)

chlam = glmmTMB(Chlamydiae ~ Floor + Treatment, 
                  data = phyla_lung_floor_wide, family = nbinom2)
Anova(chlam)

firm = glmmTMB(Firmicutes ~ Floor + Treatment, 
                  data = phyla_lung_floor_wide, family = nbinom2)
Anova(firm)

proteo = glmmTMB(Proteobacteria ~ Floor + Treatment, 
                  data = phyla_lung_floor_wide, family = nbinom2)
Anova(proteo)
```


